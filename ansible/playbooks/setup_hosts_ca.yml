- hosts: 'pki'
  tasks:
  - name: Generate SSH key for host CA
    shell: ssh-keygen -f /etc/ssh/server_ca_key -q -N ""
    args:
      creates: /etc/ssh/server_ca_key

- hosts: all
  tasks:
  - name: 'fetching ssh RSA host keys'
    fetch:
      src: /etc/ssh/ssh_host_rsa_key.pub
      dest: "{{inventory_dir}}/storage/ssh_keys/"

  - name: 'copying SSH RSA hosts files into PKI'
    copy:
      src: "{{inventory_dir}}/storage/ssh_keys/{{item}}/etc/ssh/ssh_host_rsa_key.pub"
      dest: /etc/ssh/ssh_{{item}}_rsa_key.pub
      owner: root
      group: root
      mode: 0644
    when: "'pki' in group_names"
    with_items: "{{play_hosts}}"

  - name: 'Signing Hosts keys'
    shell: "ssh-keygen -s /etc/ssh/server_ca_key -I host_{{item}} -h -n {{item}} -V +52w /etc/ssh/ssh_{{item}}_rsa_key.pub"
    args:
      creates: "/etc/ssh/ssh_{{item}}_rsa_key-cert.pub"
    with_items: "{{play_hosts}}"
    when: "'pki' in group_names"

  - name: 'fetching signed hosts CA ssh keys'
    fetch:
        src: "/etc/ssh/ssh_{{item}}_rsa_key-cert.pub"
        dest: "{{inventory_dir}}/storage/ssh_signed_host_keys/"
        flat: yes
    when: "'pki' in group_names"
    with_items: "{{play_hosts}}"

  - name: 'debug'
    debug:
      var: play_hosts

  - name: 'copying signed hosts key in servers'
    copy:
      src: "{{inventory_dir}}/storage/ssh_signed_host_keys/ssh_{{item}}_rsa_key-cert.pub"
      dest: /etc/ssh/ssh_known_hosts
      owner: root
      group: root
      mode: 0644
    when: inventory_hostname == item
    with_items: "{{play_hosts}}"





